---
title: My heart beats for U â€”â€” å¿ƒç‡åŒæ­¥ Grafana å±•ç¤º
tags: ["æŠ˜è…¾","Grafana","å¿ƒç‡","Apple Watch"]
published: 2025-03-31T23:51:00+08:00
---
import { Image } from 'astro:assets';
æ•´äº†ä¸ªå°æ´»ï¼šæŠŠè‹¹æœå¥åº·çš„å¿ƒç‡å®šæ—¶åŒæ­¥åˆ°æœåŠ¡å™¨ä¸Šï¼Œå¹¶ç”± Grafana ç»˜åˆ¶å±•ç¤ºï¼Œæ•ˆæœå¤§æ¦‚å¦‚ä¸‹ï¼š

<Image src="https://blog-img.shinya.click/2025/e01807e95f9c8ea4384d2c4d8f4fe3cb.png" />

<del>å¯ä»¥ç‚¹å‡»åšå®¢å³ä¸Šè§’çš„ â™¥ï¸ æ ‡å¿—æŸ¥çœ‹ï¼Œå› ä¸ºå¥—äº† Cloudflare Tunnelï¼Œå›½å†…è®¿é—®é€Ÿåº¦ä¸ä½³ï¼Œå°½é‡æŒ‚ğŸªœè®¿é—®ã€‚</del>å·²ä¸‹çº¿ï¼Œç”±äºæ›´æ¢äº† Oppo æ‰‹æœºï¼Œå¿ƒç‡æ— æ³•åŒæ­¥ä¸Šä¼ äº†

å¤§æ¦‚çš„æ€è·¯å°±æ˜¯ä½¿ç”¨è¿™ä¸ª app [Health Auto Export - JSON+CSV](https://apps.apple.com/us/app/health-auto-export-json-csv/id1115567069?l=zh-Hans-CN) çš„ Restful API çš„åŠŸèƒ½ï¼Œè®¾ç½®å®šæ—¶å°†å¿ƒç‡æ•°æ®å‘é€åˆ°éƒ¨ç½²çš„ http æ¥å£ä»¥å†™å…¥ InfluxDBï¼Œå†ç”± Grafana è¿æ¥ InfluxDB ç»˜åˆ¶çœ‹æ¿

[Health Auto Export - JSON+CSV](https://apps.apple.com/us/app/health-auto-export-json-csv/id1115567069?l=zh-Hans-CN) è¿™ä¸ª app å¦‚æœæƒ³è¦å®šæ—¶åŒæ­¥ï¼Œéœ€è¦å¼€é€š Premiumï¼ŒLifetime ç¾åŒºæ˜¯ 24.99 USDï¼Œæœ‰ç‚¹å°è´µï¼Œä½†ä¼¼ä¹ä¹Ÿæ²¡æœ‰ä»€ä¹ˆå¹³æ›¿æ–¹æ¡ˆ

è®¢é˜…åæ–°å»ºä¸€ä¸ª Automationï¼š

* Automation Type ä¸º `REST API`â€‹
* URL å°±æ˜¯ä½ ä¸‹é¢è¦éƒ¨ç½²çš„æœåŠ¡çš„åœ°å€ï¼ŒAPI è·¯å¾„ä¸º `/push/heart_rate`â€‹
* Data Type é€‰æ‹© `Health Metrics`â€‹
* Select Health Metrics å‹¾é€‰ `Heart Rate`â€‹
* Export Format é€‰æ‹© JSON
* Sync Cadence å¯ä»¥é€‰æ‹© 1 åˆ†é’Ÿä¹Ÿå¯ä»¥é€‰æ‹© 5 åˆ†é’Ÿï¼ŒApple Watch å¹¶ä¸ä¼šä¸€ç›´ç›‘æµ‹å¿ƒç‡

å‹¾ä¸Š Enable å³å¯ï¼Œä¸ºäº†ä¿è¯åœ¨ç¨‹åºé€€å‡ºåè¿˜èƒ½åŒæ­¥ï¼Œå¯ä»¥æ·»åŠ ä¸€ä¸ªæ¡Œé¢å°ç»„ä»¶

æ¥ç€å°±æ˜¯éƒ¨ç½²æœåŠ¡å¼€æ”¾ Restful API ç«¯å£ï¼Œæ¥æ”¶æ•°æ®å¹¶å†™å…¥ InfluxDB äº†ã€‚éƒ¨ç½² InfluxDB å¯ä»¥è‡ªè¡Œ Google ä¸å†èµ˜è¿°ï¼Œæ³¨æ„æœåŠ¡ç”¨çš„æ˜¯ InfluxDB 2

æœåŠ¡çš„æºç åœ¨ [reekystive/healthkit-collector](https://github.com/reekystive/healthkit-collector)ï¼Œæ˜¯ä¸ª node é¡¹ç›®ï¼Œå¯ä»¥ç›´æ¥ç”¨ pnpm å¯åŠ¨ç›‘å¬ 3000 ç«¯å£ã€‚æˆ‘å†™äº†ä¸ª Dockerfile å°†å…¶æ‰“åŒ…æˆ docker é•œåƒï¼Œéƒ¨ç½²åœ¨å®¶é‡Œçš„æœåŠ¡å™¨ä¸Š

```go
FROM node:20-alpine AS builder

# Install pnpm
RUN corepack enable && corepack prepare pnpm@9.14.2 --activate

# Set working directory
WORKDIR /app

# Copy package.json and pnpm-lock.yaml
COPY package.json pnpm-lock.yaml* ./

# Install dependencies
RUN pnpm install --frozen-lockfile

# Copy source code
COPY . .

# Build the application
RUN pnpm build

# Stage 2: Production stage
FROM node:20-alpine AS production

# Install pnpm
RUN corepack enable && corepack prepare pnpm@9.14.2 --activate

# Set working directory
WORKDIR /app

# Copy package.json and pnpm-lock.yaml
COPY package.json pnpm-lock.yaml* ./

# Install production dependencies only
RUN pnpm install --prod --frozen-lockfile

# Copy built application from builder stage
COPY --from=builder /app/dist ./dist

# Set environment variables
# These are default values that can be overridden when running the container
ENV NODE_ENV=production
ENV PORT=3000

# Expose the port your app runs on (using the PORT environment variable)
EXPOSE ${PORT}

# Command to run the application
CMD ["node", "dist/index.js"]
```

å¯åŠ¨æ—¶éœ€è¦è®¾ç½®å››ä¸ªè¿æ¥ InfluxDB ä½¿ç”¨çš„ç¯å¢ƒå˜é‡

```
INFLUXDB_TOKEN='your_influxdb_token'
INFLUXDB_URL='your_influxdb_url'
INFLUXDB_ORG='your_influxdb_org'
INFLUXDB_BUCKET='your_influxdb_bucket'
```

éƒ¨ç½²å®Œæˆåå¯ä»¥å°è¯•è¿›è¡Œä¸€æ¬¡åŒæ­¥ï¼ŒæœåŠ¡ä¼šè¾“å‡ºå†™å…¥ DB æˆåŠŸçš„ log

æœ€åå°±æ˜¯éƒ¨ç½²ä¸ª Grafana ç»˜åˆ¶ä»ªè¡¨ç›˜äº†ï¼Œæ·»åŠ å¥½ Data Sourceï¼Œæ–°å»ºä»ªè¡¨ç›˜ï¼ŒæŸ¥è¯¢è¯­å¥å¦‚ä¸‹

```
from(bucket: "bpm")
  |> range(start: v.timeRangeStart, stop: v.timeRangeStop)
  |> filter(fn: (r) => r["_measurement"] == "heart_rate")
  |> filter(fn: (r) => r["_field"] == "avg" or r["_field"] == "max" or r["_field"] == "min")
```

Enjoyï¼
