---
title: GFWの原理考察
tags: ["試行錯誤","ファイアウォール","国際インターネット","VPN"]
lang: ja
published: 2024-06-23T15:31:32+08:00
abbrlink: fiddling/tech-about-gfw
description: "GFWの動作メカニズムは単なる出口ゲートウェイの監視ではなく、バイパス監視技術によって国際トラフィックを検査しています。この方法により、すべての出入国IPパケットがGFWクラスターに複製され、深い分析とフィルタリングが行われます。この点を理解することは、VPN（npy）方法の研究に不可欠であり、検閲の具体的な経路と技術手段を明らかにします。GFWのネットワークトポロジーを深く探ることは、より効果的にネットワーク検閲に対処し回避する助けとなります。"
---
技術に罪はない。

> ファイアウォール（英語：Great Firewall、GFW）、中国国家ファイアウォール、または単に「壁」や「ファイアウォール」とも呼ばれ、中国ネット情報弁公室はこれを「データ越境セキュリティゲートウェイ」と称し、同国政府が国際インターネットの出口コンテンツをフィルタリングするためのハードウェアおよびソフトウェアシステムの集合体である。———— Wikipedia

GFWに効果的に対抗するには、どのウェブサイトがブロックされているかだけに注目するのではなく、そのブロックメカニズムを深く理解すべきです。Googleがブロックされていることを知っても直接VPN（npy）突破に役立つわけではありませんが、GFWがGoogleをどのようにブロックしているかを理解することは、VPN（npy）方法の選択と実装にとって極めて重要です。したがって、VPN（npy）方法を議論する前に、まずGFWのブロック原理を深く研究しなければなりません。

### GFWはどこにあるのか

多くの人は当然のように考えるかもしれません：GFWは当然出口ゲートウェイに配置されており、そこで全ての出口トラフィックを直接キャプチャして検査していると。しかし実際には、gfwrev.blogspot.comの検証によると、GFWは「3つの国際出口でバイパス監視を行っている」とされ、スプリッティング技術を用いてすべての出入国IPパケットをGFWクラスターに複製し検査しています。推測されるGFWのネットワークトポロジーは以下の通りです（画像出典：gfwrev.blogspot.com）：

![gfw topology](https://blog-img.shinya.click/2025/4beb5462a598c9015c56c75fa73ae301.svg)

GFWは異なる回線のリンク異種性を結合し、多様なリンク結合技術を研究しています（出典：[高速ネットワーク環境下の侵入検知システム構造研究](https://xueshu.baidu.com/usercenter/paper/show?paperid=f46cb7e5a6dbf7b9cb81b1dd3b9965ce)）。『国際通信出入口局管理規則』によれば、主要ISPは共用の国際光ケーブルで合流し、安管センター（CNNISC）は独立した交換センターを持ち、各ISPはそれぞれの交換センターに接続しています。異なるISPのリンク仕様に対応するため、GFWの交換センターは異なるリンクを統合し、各ISPからバイパス接続を引き出しています。接続回線は主に光ファイバーであるため「バイパススプリッティング」と呼ばれます。実験により、GFWの接続地点は必ずしも最終ホップに近いわけではなく、図中では破線で示されています。

これらに関しては、より厳密な研究論文があります：[Internet Censorship in China: Where Does the Filtering Occur?](https://web.eecs.umich.edu/~zmao/Papers/china-censorship-pam11.pdf)

初期（2010年）の研究では、GFWプロジェクトは「仮想計算環境実験床」計画として偽装されていると考えられています。

> 「仮想計算環境実験床」は国家コンピュータネットワーク緊急技術処理調整センター（CNCERT/CC）とハルビン工業大学（HIT）が協力して構築し、全国31省のネットワーク基盤と計算資源を統合・活用し、大規模でオープンかつ安全、動的で制御可能な仮想計算環境実験プラットフォームを構築し、仮想計算環境の集約と協調メカニズムを研究・検証するものです。

「仮想計算環境実験床」公開論文：[計算グリッド環境下における多アドレス協調型ジョブレベルタスクスケジューリングアルゴリズム](https://dds.sciengine.com/cfs/files/pdfs/1674-5973/LcNrPPSfzafrc3Pmn.pdf)によると、2005年のプラットフォーム構成は以下の通りです：

| サイト | 地理的位置 | 機種 | ノード数 | 各ノードのプロセッサ | 各ノードのメモリ |
|  ----  | ----  |  ----  | ----  |  ----  | ----  |
|CNCERT/CC|北京 | 曙光4000L|128ノード|2*Xeon 2.4G|RAM2G|
|HIT|ハルビン | 曙光サーバー|32ノード|2*Xeon 2.4G|RAM2G|
|CNCERT/CC|上海|Beowulfクラスター|64ノード|2*AMD Athlon 1.5G|RAM2G|

もちろん、これは2005年の構成であり、現在のGFWのハードウェア・ソフトウェア構成は容易に特定できません。

### データ処理

GFWはIPパケットを取得後、あなたとサーバー間の通信を継続させるかどうかを決定します。過度に攻撃的であってはならず、全国的に海外サイトへのアクセスを遮断することはその存在意義に反します。GFWはIPパケットの意味を理解した上で、あなたと海外サーバー間の接続を安全に遮断するか判断します。まずTCPプロトコルを再構築し、最終的に完全なバイトストリームを復元し、その上でHTTPなどの具体的なアプリケーションプロトコルを分析します。アプリケーションプロトコル内に不適切な内容があるか調べ、対応方法を決定します。

議論を簡単にするため、以下の3つのTCPパケットを仮定します：

```
IPパケット1：TCPパケットを含み、データ：Get /inde
IPパケット2：TCPパケットを含み、データ：x.html H
IPパケット3：TCPパケットを含み、データ：TTP/1.1
```

再構築は、IPパケット1の「GET /inde」とIPパケット2の「x.html H」、IPパケット3の「TTP/1.1」を結合し、「GET /index.html HTTP/1.1」にすることです。結合されたデータはテキストか暗号化されたバイナリプロトコルかもしれません。具体的にはあなたとサーバー間で約束されたものです。GFWは盗聴者として推測しなければ内容を知りません。HTTPプロトコルは標準化されており暗号化されていないため、GFWは再構築後に簡単にHTTPを使っていることやアクセス先サイトを把握できます。

このようなバイトストリームの再構築で難しいのは膨大なトラフィックの処理です。この問題は[このブログ](http://gfwrev.blogspot.tw/2010/02/gfw.html)で明確に説明されています。原理はウェブサイトのロードバランサーと同様です。特定の送信元と宛先に対してハッシュアルゴリズムでノードを決定し、そのノードに関連するトラフィックを全て送ることで、一つのノードでTCPセッションの単方向バイトストリームを再構築できます。

最後に議論を完結させるために2点述べます：

1. GFWの再構築はバイパスのスプリッティングによるものですが、GFWの全ての機器がバイパス上にあるわけではありません。後述のように、一部のGFW機器はバックボーンルーター上に配置され、GoogleのHTTPSの断続的なパケットロスなど、GFWが一部のIPルーティングに関与していることを示しています。
2. 再構築は単方向のTCPストリームであり、GFWは双方向の会話内容には関心がなく、片方向の内容だけで判断します。しかし監視自体は双方向であり、国内から国外、国外から国内のトラフィックは両方再構築され分析されます。つまり一つのTCP接続はGFWにより2つのバイトストリームに分けられます。

### 分析

分析はGFWがバイトストリームを再構築した後に行う第二段階です。再構築では主にIP、TCP、UDPプロトコルを処理しますが、分析では多種多様なアプリケーション層の複雑なプロトコルを理解する必要があります。場合によっては新しいプロトコルを独自に発明することも可能です。

総じて、GFWのプロトコル分析には似て非なる2つの目的があります。第一は不適切な内容の拡散防止、例えばGoogle検索で「してはいけない」キーワードを検索することの阻止。第二はVPN（npy）などの検閲回避ツールの利用防止です。

GFWが第一の目的を達成するために、HTTPやDNSなどのプロトコルの平文検査を行います。大まかな方法は以下の通りです：

```
1. 特徴検出
2. パケット分解
3. キーワードマッチング
```

HTTPのようなプロトコルは明確な特徴があるため、最初のステップは問題ありません。GFWはHTTPパケットを検出すると、HTTPのプロトコル規則に従ってパケットを分解します。この分解はGFWがプロトコルを理解して行います。例えばHTTPのGETリクエストからURLを取得します。次にGFWはこのURLをキーワードと照合し、例えばURLにTwitterが含まれているかを調べます。なぜ分解が必要かというと、分解後の検査はより精密で誤検知を防ぎ、全文検索よりもリソースを節約できるためです。また、[liruqi/jjproxy](https://github.com/liruqi/jjproxy)のコアはGFWのHTTPパケット分解の脆弱性に基づいていますが、このバグは既に修正されています。原理はGFWがHTTPパケットを分解する際、余分な\r\nを処理できなかったが、google.comは正しく処理できたというものです。この例から、GFWはまずプロトコルを理解し、その後キーワードマッチングを行っていることが証明されます。キーワードマッチングは効率的な正規表現アルゴリズムを用いていると考えられ、特に議論の余地はありません。

現在知られているGFWのプロトコル分析は以下の通りです：

#### DNSプロトコル

GFWはUDPの53番ポートのDNSクエリを分析できます。クエリのドメイン名がキーワードにマッチするとDNSハイジャックが行われます。これは単なるブラックリストではなく、正規表現に似た仕組みを用いていると断言できます。理由はサブドメインが非常に多いためです。証拠として：

- 2010年3月、チリのドメイン登録技術者が中国のルートサーバーにfacebook.com、youtube.com、twitter.comなどの問い合わせを行った際、応答が異常であることを発見。中国のルートサーバー運営者Netnodは一時的に国際インターネット接続を切断。セキュリティ専門家はNetnodの問題ではなく、中国政府がネットワークを改変したことが原因と推測。
- 2014年1月21日午後3時半、中国のインターネットドメイン解決に異常が発生し、多数のサイトが誤ってIPアドレス65.49.2.178（米カリフォルニア州フェリモンのHurricane Electric社）に解決された。このIPはVPN（npy）接続ノードとして使用されていた。動的ネット社と研究者はGFWスタッフの操作ミスと考え、一部は真のハッカーがこのIPを踏み台に攻撃を仕掛けた可能性も排除できないとした。
- 2015年1月2日、汚染方法が変更され、GFWは固定のブロックIPではなく、海外の実在しアクセス可能なサイトのIPを注入。これにより海外サーバーが中国からのDDoS攻撃を受け、一部サイトが中国IPをブロック。4月にCNCERTはこれが海外攻撃によるものと声明。

出典：https://zh.wikipedia.org/wiki/%E9%98%B2%E7%81%AB%E9%95%BF%E5%9F%8E

#### HTTPプロトコル

GFWはHTTPプロトコルを識別し、GETのURLとHOSTを検査します。キーワードにマッチするとTCP RSTで接続を遮断します。

#### TLSプロトコル

初期のTLSバージョンでは、サーバーのハンドシェイク応答（証明書含む）は暗号化されておらず、GFWはこれを嗅ぎ取りアクセス先サイトを知ることができました。TLS 1.3以降はServerHello以降のハンドシェイク情報も暗号化され、証明書情報の検出は防止されると一般に考えられています。

しかし現在広く使われるSNI（Server Name Indication）プロトコルはTLSの拡張であり、クライアントがハンドシェイク開始時に接続先ドメイン名をサーバーに伝えます。これは複数のHTTPSサイトを運用するために必要ですが、この拡張は暗号化されていません。GFWはSNIの平文ドメイン名を嗅ぎ取りブロックしています。HTTPSはHTTP＋TLSなので、HTTPS接続の検査はHTTP検査に分類されます。

**注意：GFWはターゲットドメインの証明書を取得できないため、HTTPSの実際の内容を解読することはできません。**

#### トラフィック特徴識別

GFWの第二の目的はVPN（npy）ソフトウェアの封殺です。これを達成するためにGFWはより過激な手段を取ります。理由は簡単で、HTTPプロトコルの封鎖は誤検知がインターネットの正常運用に影響するため、GFWはインターネットと共生関係にあります。だがTORのようにほぼ純粋にVPN（npy）目的のプロトコルは検出されれば即座に封殺されます。GFWが各種VPNプロトコルをどのように封鎖しているかは私も詳しく知りませんが、状況は日々変化しています。以下2つの例でGFWの高度な技術を示します。

最初の例はGFWによるTORの自動封鎖で、GFWがプロトコル自体を最大限理解しようとする姿勢を示しています。ブログhttps://blog.torproject.org/blog/knock-knock-knockin-bridges-doorsによると、中国のIPから米国のTORブリッジに接続するとGFWに検出されます。15分後、GFWはクライアントを装いTORプロトコルでそのブリッジに接続を試みます。ブリッジがTORであると確認されると、そのポートを封鎖します。ポートを変えればしばらく使えますが再度封鎖されます。これはGFWが国際出口トラフィックからTORブリッジを鋭敏に検出できることを示し、TORのハンドシェイクに特徴的な署名があるためです。もう一つはGFWが自らクライアントを装い接続を試みる労を惜しまない点です。

二つ目の例はGFWが暗号化トラフィックの内容に敏感語があるかどうかは気にせず、VPN（npy）疑いのあるトラフィック、特に商用VPNサービスを封殺することです。（ほぼ確実に）GFWは暗号化トラフィックの中からVPN（npy）サービスを機械的に識別できるレベルに進化しています。

GFWの最近の重点はネットワークトラフィックの分析にあり、VPN（npy）トラフィックを識別する研究はまだ少なく、大規模展開は問題を起こしやすいという特徴があります。

### 干渉手段

GFWはプロトコル分析で「脅威のある」バイトストリームと判断すると、以下の方法で通信を妨害します：

#### IPブロック

一般的に人手による検査後の対応です。GFWの機械的検出で直接IPを封鎖する方法は聞いたことがありません。通常はGFWが検出し、TCP RSTで接続をリセットします。一定期間後にIPが封鎖され、明確な時間規則はありません。推測ですが、全体的なIP封鎖は人手介入が必要です。全体的なIP封鎖と、部分的なIP封鎖（例えば3分間だけ特定IPへのアクセスを封鎖し他はアクセス可能）とは全く異なる方法です。現象は似ていますが、pingでtwitter.comを試せば長期間封鎖されていることがわかります。

実装方法は無効ルート（ブラックホール）をバックボーンルーターのルーティングテーブルに追加し、これらのルーターが指定IPへのパケットを破棄します。ルーティングテーブルはBGPプロトコルで動的に更新されます。GFWは封鎖IPリストを管理し、BGPで広報するだけです。国内のバックボーンルーターはGFWの一部のように振る舞い、共犯者となります。

tracerouteで全体的に封鎖されたIPを調べると、パケットはGFWの国際出口に到達する前に電信や聯通のルーターで破棄されていることがわかります。これがBGP広報の効果です。

#### DNSハイジャック

これも人手検査後の対応です。不適切なサイトを発見すると、そのドメイン名をハイジャックリストに追加します。原理はDNSとIPプロトコルの弱点に基づき、DNSもIPもサーバーの権威性を検証せず、DNSクライアントは最初に受け取った回答を盲信します。つまりfacebook.comを問い合わせると、GFWは正しい回答が返る前に先に偽の回答を送り、DNSサーバーを装います。

#### TCP接続リセット

TCPプロトコルではRSTパケットを受け取ると接続は即座に切断されます。ブラウザでは接続がリセットされたと表示されます。このエラーは多くの人に馴染みがあるでしょう。私の感覚では、これはGFWの主要な封鎖手段です。多くのRSTは条件付きで、URLに特定キーワードが含まれると発生します。facebookなど多くのサイトがこの対象です。また無条件にRSTされるサイトもあり、特定IPとポートに対して内容に関係なくRSTが送られます。有名な例はHTTPSのWikipediaです。GFWはIPv4の弱点を利用し、ネット上で誰にでも成りすましてパケットを送れます。これによりRSTがGoogleから送られたとあなたに信じ込ませ、GoogleにはあなたがRSTを送ったと信じ込ませることが可能です。

#### ポート封鎖

GFWの主体はバックボーンルーターのバイパス上にある侵入検知装置（IDS）で、スプリッティング技術でパケットをキャプチャし侵入検知を行います。加えてこのルーターはポート封鎖（IPS）にも使われます。侵入検知後、GFWはTCP RSTで接続を遮断するだけでなく、バックボーンルーターで特定IPやポートに対してポート封鎖やIP封鎖、選択的パケット破棄などの封鎖措置を行います。これはルーター上の「iptables」機能に似ており（ネットワーク層とトランスポート層のリアルタイムパケット分解とルールマッチング）、CiscoルーターではACL Based Forwarding（ABF）と呼ばれます。ルールは全国で同期され、一台のルーターがポートを封鎖すれば、全国のGFW搭載バックボーンルーターも同様に封鎖します。通常このポート封鎖はVPN（npy）サーバーに対して行われ、SSHやVPNサービスを検出すると、全国の出口バックボーンルーターにACLルールを展開し、そのサーバーの特定ポートからの下りパケットをフィルタリングします。つまり国外から国内へのパケットで、送信元IPが封鎖されたサーバーIP、送信元ポートが封鎖ポートの場合、そのパケットは破棄されます。このルールの特徴は、上りパケットはサーバーに届くが、下りパケットは破棄されることです。

封鎖されたポートをサーバーが変更して対応しても、すぐに再封鎖されます。複数回試みるとIP封鎖に至ります。推測ですが、ポート封鎖はGFWの自動対応ではなく、ブラックリストと人手によるフィルタリングで実施されているようです。その理由の一つは、封鎖は昼間の勤務時間に多発しているという報告があるためです。

#### 逆壁（リバースファイアウォール）

多くのVPN（npy）サービスが国内中継サーバーを使っていますが、GFWは異常な大量の国外トラフィックを検出すると、特に全国会議や国慶節などの特別期間にそのサーバーを逆壁化します。具体的には国外サーバーがその逆壁化されたIPにアクセスできなくなります。pingすると国外側は全てタイムアウト（赤）、国内側は正常（緑）となります。対処法は少なく、IPを変更するか、敏感期間が過ぎるのを待つしかありません。

> 本文は以下を転載・編集・補足したものです
> 1. https://ednovas.xyz/2022/06/25/gfw/#%E4%B8%AD%E8%BD%AC
> 2. https://gfwrev.blogspot.com/2010/02/gfw.html